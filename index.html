<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>呑み迷子 - NOMI-MAIGO</title>
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
    <script>
    (function(d) {
        var config = {
            kitId: 'gpu6rtb',
            scriptTimeout: 3000,
            async: true
        },
        h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
    })(document);
    </script>

    <style>
        body {
            margin: 0;
            font-family: "hot-gekai11kk", "Sawarabi Mincho", serif;
            background-image: url('BG.png'); 
            background-size: cover;
            background-attachment: fixed;
            background-position: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }
        .container, .maigo-fuda {
            background-color: rgba(255, 255, 255, 0.6) !important; 
            border-radius: 15px;
        }

        h2, h3 {
            text-align: center;
            margin-bottom: 20px;
        }

        .order-hint {
            font-family: "ab-ootori", sans-serif;
            font-size: 28px;
            font-weight: 400;
            margin: 20px 0;
            text-align: center;
        }

        /* ミッション画面専用の調整 */
        #mission-screen .order-hint {
            font-size: 20px; /* 改行防止のため小さく設定 */
            margin: 15px 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .mission-unit { margin-bottom: 30px; }
        .mission-btns { display: flex; justify-content: space-around; gap: 10px; }

        /* 画像ボタンのスタイル */
        .m-img-btn {
            width: 130px; /* 達成・失敗ボタンの横幅 */
            height: auto;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .m-img-btn:active { transform: scale(0.95); }

        .f-img-btn {
            width: 140px; /* 下部ボタンの横幅 */
            height: auto;
            cursor: pointer;
        }

        .footer-btns { 
            display: flex; 
            justify-content: space-around; 
            margin-top: 30px; 
            width: 100%;
        }

        /* 以下、既存のレイアウト維持用CSS */
        header { width: 100%; padding: 30px 0 10px; display: flex; justify-content: center; align-items: center; }
        .container, .maigo-fuda { width: 92%; max-width: 400px; margin: 20px auto; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        .section-title { text-align: center; margin-top: 0; font-size: 1.2rem; }
        .shop-card { display: flex; align-items: center; background: #fff; border: 1px solid #1a237e; margin-bottom: 12px; padding: 10px; text-align: left; }
    </style>
</head>
<body>

<div id="mission-screen" class="container" style="display: none;">
    <h2 class="section-title">お店</h2>
    <div id="selected-shop-card"></div> 
    
    <div class="mission-unit">
        <h3 class="order-hint" id="mission-text-1">一杯目にトマトハイを頼め</h3>
        <div class="mission-btns">
            <img src="fail.png" class="m-img-btn" onclick="this.style.opacity='0.5'" alt="失敗">
            <img src="achievement.png" class="m-img-btn" onclick="this.style.opacity='0.5'" alt="達成">
        </div>
    </div>

    <div id="dynamic-mission-container"></div>

    <div class="footer-btns">
        <img src="exit.png" class="f-img-btn" onclick="location.reload()" alt="店を出る">
        <img src="next.png" class="f-img-btn" onclick="getNextMission()" alt="次の迷子札">
    </div>
</div>

<header>
    <div class="logo-area">
        <img src="logo.png" alt="呑み迷子" style="width: 150px; height: auto;">
    </div>
</header>

<div class="container">
    <h2 class="section-title">お店候補</h2>
    <div id="shop-list"></div> 
</div>

<div class="maigo-fuda">
    <h3 class="section-title">迷子札</h3>
    <div id="drink-hint" class="order-hint">一杯目は何頼む？</div>
</div>

<div id="button-container" style="text-align: center;">
    <img id="action-button" src="search.png" onclick="startGacha()" style="cursor: pointer; width: 300px; max-width: 80%;">
</div>

<script>
// 1. お店を表示する関数
function displayShops(data, currentRange) {
    const shopList = document.getElementById('shop-list');
    const hint = document.getElementById('drink-hint');
    const drinks = ["生ビール", "ハイボール", "レモンサワー", "日本酒", "焼酎", "ウーロン茶", "カシオレ", "トマトハイ"];

    // 迷子札の内容をランダムに決定
    if(hint) {
        hint.innerText = "一杯目は " + drinks[Math.floor(Math.random() * drinks.length)];
    }

    if(!shopList) return;
    shopList.innerHTML = "";

    if (!data || !data.results || !data.results.shop || data.results.shop.length === 0) {
        shopList.innerHTML = '<p style="text-align:center;">近くにお店が見つかりませんでした。</p>';
        return;
    }

    // 検索範囲を表示
    const rangeText = document.createElement('p');
    rangeText.style = "font-size:0.8rem; color:#666; text-align:center;";
    rangeText.innerText = `(${currentRange}以内の結果)`;
    shopList.appendChild(rangeText);

    // 3件ランダムに抽出
    const shops = data.results.shop.sort(() => 0.5 - Math.random()).slice(0, 3);
    
    shops.forEach(shop => {
        const shopCard = document.createElement('div');
        shopCard.className = 'shop-card';
        shopCard.style = "display:flex; align-items:center; background:#fff; border:1px solid #1a237e; margin-bottom:10px; padding:10px; cursor:pointer; border-radius:10px; text-align:left;";

        shopCard.innerHTML = `
            <img src="${shop.photo.pc.l}" style="width:80px; height:80px; object-fit:cover; margin-right:15px; border-radius:5px;">
            <div style="flex:1;">
                <h3 style="margin:0; font-size:1rem; color:#000; font-family:sans-serif;">${shop.name}</h3>
                <p style="margin:5px 0 0; font-size:0.75rem; color:#444;">${shop.genre.name}<br>${shop.access}</p>
            </div>
        `;

        shopCard.onclick = () => {
            // メイン要素を隠す
            const selectors = ['header', '.container', '.maigo-fuda', '#button-container'];
            selectors.forEach(sel => {
                const elements = document.querySelectorAll(sel);
                elements.forEach(el => el.style.display = 'none');
            });

            // 迷子札の連動
            const currentDrink = document.getElementById('drink-hint').innerText;
            const missionDrink = document.getElementById('mission-text-1');
            if(missionDrink) {
                let cleanText = currentDrink.replace("一杯目は", "一杯目に");
                missionDrink.innerText = cleanText + "を頼め";
            }

            // ミッション画面を表示
            const missionScreen = document.getElementById('mission-screen');
            if(missionScreen) {
                missionScreen.style.display = 'block';
                const selectedPlace = document.getElementById('selected-shop-card');
                if(selectedPlace) {
                    selectedPlace.innerHTML = shopCard.innerHTML;
                    selectedPlace.style.cssText = shopCard.style.cssText;
                    selectedPlace.style.cursor = "default";
                }
            }
        };
        shopList.appendChild(shopCard);
    });
}

function getNextMission() {
    const container = document.getElementById('dynamic-mission-container');
    if (!container) return;

    // 前に出した追加指令を消して入れ替える
    container.innerHTML = ""; 

    const tasks = [
        "店主のおすすめを聞け",
        "隣の人と乾杯せよ",
        "本日のおすすめを注文せよ",
        "一番人気のつまみを頼め",
        "店員さんの名前を覚えろ",
        "揚げ物を1品頼め",
        "自分以外が頼んだ酒を頼め",
        "おすすめの日本酒を聞け"
    ];
    const randomTask = tasks[Math.floor(Math.random() * tasks.length)];

    // HTML要素をその場で生成
    const newMission = document.createElement('div');
    newMission.className = 'mission-unit';
    newMission.style.marginTop = "20px";
    newMission.style.borderTop = "1px dashed #ccc";
    newMission.style.paddingTop = "20px";

    newMission.innerHTML = `
        <h3 class="order-hint">${randomTask}</h3>
        <div class="mission-btns">
            <img src="fail.png" class="m-img-btn" onclick="this.style.opacity='0.5'" alt="失敗">
            <img src="achievement.png" class="m-img-btn" onclick="this.style.opacity='0.5'" alt="達成">
        </div>
    `;

    // 画面にガッチャンコ
    container.appendChild(newMission);

    // 新しい指令が見えるようにスムーズにスクロール
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
}

// 3. データ取得（300mから最大1000mまで再帰検索）
async function fetchAndDisplay(lat, lng, rangeIndex = 1) {
    const shopList = document.getElementById('shop-list');
    const rangeLabels = {1: "300m", 2: "500m", 3: "1000m"};
    
    if(shopList) shopList.innerHTML = `<p style="text-align:center;">${rangeLabels[rangeIndex]}圏内を探索中...</p>`;

    try {
        const response = await fetch(`/getShops?lat=${lat}&lng=${lng}&range=${rangeIndex}`);
        const data = await response.json();

        // 店がない場合は範囲を広げて再検索（最大range=3まで）
        if ((!data.results || !data.results.shop || data.results.shop.length === 0) && rangeIndex < 3) {
            return fetchAndDisplay(lat, lng, rangeIndex + 1);
        }
        displayShops(data, rangeLabels[rangeIndex]);
    } catch (e) {
        if(shopList) shopList.innerHTML = '<p style="text-align:center;">通信エラーが発生しました。</p>';
    }
}

// 4. ガチャ開始ボタン
function startGacha() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (pos) => fetchAndDisplay(pos.coords.latitude, pos.coords.longitude),
            () => alert("位置情報を許可してください")
        );
    }
}
</script>
</body>
</html>