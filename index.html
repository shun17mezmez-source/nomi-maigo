<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>呑み迷子 - NOMI-MAIGO</title>
    <link href="https://fonts.googleapis.com/css2?family=Sawarabi+Mincho&display=swap" rel="stylesheet">
    <script>
  (function(d) {
    var config = {
      kitId: 'gpu6rtb',
      scriptTimeout: 3000,
      async: true
    },
    h=d.documentElement,t=setTimeout(function(){h.className=h.className.replace(/\bwf-loading\b/g,"")+" wf-inactive";},config.scriptTimeout),tk=d.createElement("script"),f=false,s=d.getElementsByTagName("script")[0],a;h.className+=" wf-loading";tk.src='https://use.typekit.net/'+config.kitId+'.js';tk.async=true;tk.onload=tk.onreadystatechange=function(){a=this.readyState;if(f||a&&a!="complete"&&a!="loaded")return;f=true;clearTimeout(t);try{Typekit.load(config)}catch(e){}};s.parentNode.insertBefore(tk,s)
  })(document);
</script>
 
    <style>
body {
    margin: 0;
    /* ここを書き換え！ "hot-gekai11kk" を先頭に追加します */
    font-family: "hot-gekai11kk", "Sawarabi Mincho", serif;
    /* 背景画像を指定する（ファイル名を自分のものに書き換えてください） */
    background-image: url('BG.png'); 
    
    /* 画像を画面いっぱいに広げ、スクロールしても動かないように固定する */
    background-size: cover;
    background-attachment: fixed;
    background-position: center;

    /* 中央寄せにするための設定 */
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
}
.container, .maigo-fuda {
    /* 白 (255, 255, 255) で、不透明度を 0.8 (80%) に設定 */
    background-color: rgba(255, 255, 255, 0.6) !important; 
    
    /* 角を少し丸くすると、より今風になります */
    border-radius: 15px;
}

/* 2. 「お店候補」などの見出しを中央に */
h2, h3 {
    text-align: center;
    margin-bottom: 20px;
}

/* 3. 引き直すボタンを中央に */
.retry-btn {
    display: block;        /* block要素にすることでmargin: autoが効くようになる */
    margin: 30px auto;     /* 上下に30px、左右を中央揃え */
    width: 200px;
}
/* 「一杯目に何を頼む？」を筆文字（AB鳳）にする */
.order-hint {
    font-family: "ab-ootori", sans-serif; /* Adobe Fontsで指定された名前 */
    font-size: 28px;                     /* 文字の大きさ */
    font-weight: 400;                    /* Adobe指定の太さ */
    margin: 20px 0;
    text-align: center;
}
.mission-unit { margin-bottom: 30px; }
.mission-btns { display: flex; justify-content: space-around; gap: 10px; }

/* 達成・失敗ボタンの基本 */
.m-btn {
    padding: 10px 30px;
    border-radius: 8px;
    font-family: "ab-ootori", sans-serif; /* 筆文字を適用 */
    font-size: 20px;
    color: white;
    border: none;
}
.fail { background-color: #6d1a1a; } /* 渋い赤 */
.success { background-color: #3b6b9e; } /* 渋い青 */

/* 下部の大きなボタン */
.footer-btns { display: flex; justify-content: space-between; margin-top: 40px; }
.exit-btn { background-color: #b22222; padding: 10px 20px; color: white; border-radius: 5px; font-family: "ab-ootori", sans-serif;}
.next-btn { background-color: #4682b4; padding: 10px 20px; color: white; border-radius: 5px; font-family: "ab-ootori", sans-serif;}

/* ミッション画面の見出しサイズを調整 */
#mission-screen .order-hint {
    font-size: 20px;       /* 28pxから20pxに下げて改行を防ぐ */
    margin: 15px 0;
    white-space: nowrap;   /* 絶対に改行させない設定 */
    overflow: hidden;
    text-overflow: ellipsis; /* 万が一長すぎたら「...」にする */
}

/* ミッション画面内のカードも少しスリムに */
#selected-shop-card .shop-card {
    margin-bottom: 20px;
}

    </style>
</head>
<div id="mission-screen" class="container" style="display: none; background-color: rgba(255, 255, 255, 0.6) !important;">
    <h2 class="section-title">お店</h2>
    <div id="selected-shop-card"></div> <div class="mission-unit">
        <h3 class="order-hint" id="mission-text-1">一杯目にトマトハイを頼め</h3>
        <div class="mission-btns">
            <button class="m-btn fail">失敗</button>
            <button class="m-btn success">達成</button>
        </div>
    </div>

    <div class="mission-unit">
        <h3 class="order-hint" id="mission-text-2">店主のおすすめを聞け</h3>
        <div class="mission-btns">
            <button class="m-btn fail">失敗</button>
            <button class="m-btn success">達成</button>
        </div>
    </div>

    <div class="footer-btns">
        <button class="exit-btn">店を出る</button>
        <button class="next-btn">次の迷子札</button>
    </div>
</div>

  <header>
    <div class="logo-area">
        <img src="logo.png" alt="呑み迷子" style="width: 150px; height: auto;">
    </div>
</header>

<div class="container">
    <h2 class="section-title">お店候補</h2>
    <div id="shop-list"></div> 
</div>

<div class="maigo-fuda">
    <h3 class="section-title">迷子札</h3>
    <div id="drink-hint" class="order-hint">一杯目は何頼む？</div>
</div>

<div id="button-container" style="text-align: center;">
    <img id="action-button" src="search.png" onclick="startGacha()" style="cursor: pointer; width: 300px; max-width: 80%;">
</div>

<style>
/* --- CSS: 中央揃えとレイアウトの調整 --- */

header {
    width: 100%;
    padding: 30px 0 10px; /* 上に余裕を持たせる */
    display: flex;
    justify-content: center; /* 左右中央 */
    align-items: center;
}

.logo-area {
    text-align: center;
}

.logo-text {
    margin: 0;
    font-size: 2.5rem; /* ロゴの大きさ */
    letter-spacing: 2px;
}

.logo-sub {
    font-size: 0.7rem;
    letter-spacing: 5px;
    margin-top: -5px;
}

/* 各セクションを中央寄せ */
.container, .maigo-fuda {
    width: 92%;
    max-width: 400px;
    margin: 20px auto; /* 左右autoで中央 */
    background: #fff;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    box-sizing: border-box;
}

.section-title {
    text-align: center;
    margin-top: 0;
    font-size: 1.2rem;
}

/* ボタンを中央に配置 */
.retry-btn {
    display: block;
    margin: 30px auto 60px; /* 左右autoで中央 */
    background-color: #a52a2a;
    color: white;
    border: none;
    padding: 15px 50px;
    font-size: 1.4rem;
    border-radius: 10px;
    cursor: pointer;
}
/* カードを横並びにする設定 */
.shop-card {
    display: flex;                /* 横並びにする */
    align-items: center;          /* 垂直中央 */
    background: #fff;
    border: 1px solid #1a237e;    /* 紺色の細い枠線 */
    margin-bottom: 12px;
    padding: 10px;
    text-align: left;             /* 文字は左寄せ */
}

.shop-img {
    width: 80px;                  /* 写真のサイズを固定 */
    height: 80px;
    object-fit: cover;
    margin-right: 15px;           /* 写真と文字の間の隙間 */
}

.shop-name {
    margin: 0 0 5px 0;
    font-size: 1.1rem;
    color: #1a237e;               /* 店名も紺色にすると締まります */
}

.shop-details {
    margin: 0;
    font-size: 0.8rem;
    color: #333;
    font-family: 'Sawarabi Mincho', serif; /* 詳細は読みやすい明朝体で */
}
</style>
<script>
// ボタンが押せるようになったか確認するためのログ
console.log("プログラムを読み込みました");

// 1. お店を表示する関数
// 1. お店を表示する関数
function displayShops(data, currentRange) {
    const shopList = document.getElementById('shop-list');
    const hint = document.getElementById('drink-hint');
    const drinks = ["生ビール", "ハイボール", "レモンサワー", "日本酒", "焼酎", "ウーロン茶", "カシオレ", "トマトハイ"];

    if(hint) hint.innerText = "一杯目は " + drinks[Math.floor(Math.random() * drinks.length)] + "";

    if(!shopList) return;
    shopList.innerHTML = "";

    if (!data || !data.results || !data.results.shop || data.results.shop.length === 0) {
        shopList.innerHTML = '<p style="text-align:center;">近くにお店が見つかりませんでした。</p>';
        return;
    }

    const rangeText = document.createElement('p');
    rangeText.style = "font-size:0.8rem; color:#666; text-align:center;";
    rangeText.innerText = `(${currentRange}以内の結果)`;
    shopList.appendChild(rangeText);

    const shops = data.results.shop.sort(() => 0.5 - Math.random()).slice(0, 3);
    
    shops.forEach(shop => {
        const shopCard = document.createElement('div');
        shopCard.className = 'shop-card';
        shopCard.style = "display:flex; align-items:center; background:#fff; border:1px solid #1a237e; margin-bottom:10px; padding:10px; cursor:pointer; border-radius:10px; text-align:left;";

        shopCard.innerHTML = `
            <img src="${shop.photo.pc.l}" style="width:80px; height:80px; object-fit:cover; margin-right:15px; border-radius:5px;">
            <div style="flex:1;">
                <h3 style="margin:0; font-size:1rem; color:#000; font-family:sans-serif;">${shop.name}</h3>
                <p style="margin:5px 0 0; font-size:0.75rem; color:#444;">${shop.genre.name}<br>${shop.access}</p>
            </div>
        `;

        // タップした時の画面切り替え
       // タップした時の画面切り替え
        // タップした時の画面切り替え
        shopCard.onclick = () => {
            // 1. 全てのメイン要素を確実に隠す（.containerを全て隠すことでお店候補も消えます）
            const selectors = ['header', '.container', '.maigo-fuda', '#button-container'];
            selectors.forEach(sel => {
                const elements = document.querySelectorAll(sel);
                elements.forEach(el => el.style.display = 'none');
            });

            // 2. 迷子札（一杯目）のテキストをミッション画面にコピー（「！」を除去）
            const currentDrink = document.getElementById('drink-hint').innerText;
            const missionDrink = document.getElementById('mission-text-1');
            if(missionDrink) {
                // 「！」を消して、「一杯目は」を「一杯目に」に置換
                let cleanText = currentDrink.replace("！", "").replace("一杯目は", "一杯目に");
                missionDrink.innerText = cleanText + "を頼め";
            }

            // 3. ミッション画面を表示
            const missionScreen = document.getElementById('mission-screen');
            if(missionScreen) {
                missionScreen.style.display = 'block';
                const selectedPlace = document.getElementById('selected-shop-card');
                if(selectedPlace) {
                    selectedPlace.innerHTML = shopCard.innerHTML;
                    selectedPlace.style.cssText = shopCard.style.cssText;
                    selectedPlace.style.cursor = "default";
                }
            }
        };
        shopList.appendChild(shopCard);
    });
}

// 2. データを取りに行く関数
async function fetchAndDisplay(lat, lng, rangeIndex = 2) {
    const shopList = document.getElementById('shop-list');
    const rangeLabels = {2: "500m", 3: "1000m", 5: "3000m"};
    if(shopList) shopList.innerHTML = `<p style="text-align:center;">${rangeLabels[rangeIndex]}圏内を探索中...</p>`;

    try {
        const response = await fetch(`/getShops?lat=${lat}&lng=${lng}&range=${rangeIndex}`);
        const data = await response.json();

        if ((!data.results || !data.results.shop || data.results.shop.length === 0) && rangeIndex < 5) {
            const nextRange = rangeIndex === 2 ? 3 : 5;
            return fetchAndDisplay(lat, lng, nextRange);
        }
        displayShops(data, rangeLabels[rangeIndex]);
    } catch (e) {
        if(shopList) shopList.innerHTML = '<p style="text-align:center;">エラーが発生しました。</p>';
        console.error(e);
    }
}

// 3. ガチャ開始ボタン
function startGacha() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                fetchAndDisplay(position.coords.latitude, position.coords.longitude);
            },
            () => { alert("位置情報が許可されていません"); }
        );
    } else {
        alert("お使いのブラウザは位置情報に対応していません");
    }
}
</script>